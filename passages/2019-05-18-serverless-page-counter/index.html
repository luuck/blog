<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>基于ServerLess的极简网页计数器：源码分析与最佳实践 | 心谭博客</title>
    <meta name="description" content="专注前端与算法的博客">
    <script type="text/javascript" src="/scripts/baidu-analytics.js" async=""></script>
  <link rel="icon" href="/favicon.ico">
    
    <link rel="preload" href="/assets/css/0.styles.8c46daec.css" as="style"><link rel="preload" href="/assets/js/app.8d89d060.js" as="script"><link rel="preload" href="/assets/js/2.e1e0c7d5.js" as="script"><link rel="preload" href="/assets/js/3.facfa05b.js" as="script"><link rel="preload" href="/assets/js/19.43a703c5.js" as="script"><link rel="preload" href="/assets/js/5.937ae87d.js" as="script"><link rel="prefetch" href="/assets/js/10.7840874b.js"><link rel="prefetch" href="/assets/js/100.121c62f5.js"><link rel="prefetch" href="/assets/js/101.1da0951f.js"><link rel="prefetch" href="/assets/js/102.ce51633a.js"><link rel="prefetch" href="/assets/js/103.e5762195.js"><link rel="prefetch" href="/assets/js/104.09f32580.js"><link rel="prefetch" href="/assets/js/105.bb7a68e0.js"><link rel="prefetch" href="/assets/js/106.def85912.js"><link rel="prefetch" href="/assets/js/107.f1b569e7.js"><link rel="prefetch" href="/assets/js/108.a30653cb.js"><link rel="prefetch" href="/assets/js/109.1635af65.js"><link rel="prefetch" href="/assets/js/11.ac257d6e.js"><link rel="prefetch" href="/assets/js/110.f985df39.js"><link rel="prefetch" href="/assets/js/111.b79c094f.js"><link rel="prefetch" href="/assets/js/112.c95d0a0c.js"><link rel="prefetch" href="/assets/js/113.857888ea.js"><link rel="prefetch" href="/assets/js/114.eadfea49.js"><link rel="prefetch" href="/assets/js/115.a062b05c.js"><link rel="prefetch" href="/assets/js/116.1dfdbc65.js"><link rel="prefetch" href="/assets/js/117.dc761476.js"><link rel="prefetch" href="/assets/js/118.21dd15eb.js"><link rel="prefetch" href="/assets/js/119.22eb7031.js"><link rel="prefetch" href="/assets/js/12.a6e07cb1.js"><link rel="prefetch" href="/assets/js/120.8b21b265.js"><link rel="prefetch" href="/assets/js/121.cfd680d6.js"><link rel="prefetch" href="/assets/js/122.3766e467.js"><link rel="prefetch" href="/assets/js/123.82549f32.js"><link rel="prefetch" href="/assets/js/124.bb56d4d9.js"><link rel="prefetch" href="/assets/js/125.231759ac.js"><link rel="prefetch" href="/assets/js/126.277a4c97.js"><link rel="prefetch" href="/assets/js/127.1408c292.js"><link rel="prefetch" href="/assets/js/128.3462c6f7.js"><link rel="prefetch" href="/assets/js/129.847591e6.js"><link rel="prefetch" href="/assets/js/13.a8c6b11b.js"><link rel="prefetch" href="/assets/js/130.74689f33.js"><link rel="prefetch" href="/assets/js/131.7deb2d07.js"><link rel="prefetch" href="/assets/js/132.963e5a92.js"><link rel="prefetch" href="/assets/js/133.ee33c01e.js"><link rel="prefetch" href="/assets/js/134.5b9ea12b.js"><link rel="prefetch" href="/assets/js/135.521389b9.js"><link rel="prefetch" href="/assets/js/136.a5daf088.js"><link rel="prefetch" href="/assets/js/137.14ce150b.js"><link rel="prefetch" href="/assets/js/138.55b9107b.js"><link rel="prefetch" href="/assets/js/139.5d1746c5.js"><link rel="prefetch" href="/assets/js/14.bb39005e.js"><link rel="prefetch" href="/assets/js/140.8742e3eb.js"><link rel="prefetch" href="/assets/js/141.5661ec9a.js"><link rel="prefetch" href="/assets/js/142.44871095.js"><link rel="prefetch" href="/assets/js/143.3ea75964.js"><link rel="prefetch" href="/assets/js/144.96969688.js"><link rel="prefetch" href="/assets/js/145.0d23ebd5.js"><link rel="prefetch" href="/assets/js/146.9711c0e2.js"><link rel="prefetch" href="/assets/js/147.1a11a99b.js"><link rel="prefetch" href="/assets/js/148.15dd1885.js"><link rel="prefetch" href="/assets/js/149.38af1de0.js"><link rel="prefetch" href="/assets/js/15.7113ef47.js"><link rel="prefetch" href="/assets/js/150.80fe0c27.js"><link rel="prefetch" href="/assets/js/151.7d84e079.js"><link rel="prefetch" href="/assets/js/152.7e2eba95.js"><link rel="prefetch" href="/assets/js/153.b98584ac.js"><link rel="prefetch" href="/assets/js/154.a9964ef6.js"><link rel="prefetch" href="/assets/js/155.1d049698.js"><link rel="prefetch" href="/assets/js/156.3bd14e7b.js"><link rel="prefetch" href="/assets/js/157.93bd8a8e.js"><link rel="prefetch" href="/assets/js/158.eb78a787.js"><link rel="prefetch" href="/assets/js/159.9d421dc2.js"><link rel="prefetch" href="/assets/js/16.e856a463.js"><link rel="prefetch" href="/assets/js/160.1eda4d88.js"><link rel="prefetch" href="/assets/js/161.8368b364.js"><link rel="prefetch" href="/assets/js/162.0ce0ed1a.js"><link rel="prefetch" href="/assets/js/163.c87c5933.js"><link rel="prefetch" href="/assets/js/164.6bd622cd.js"><link rel="prefetch" href="/assets/js/165.b857bbf6.js"><link rel="prefetch" href="/assets/js/166.6c1a4f8e.js"><link rel="prefetch" href="/assets/js/167.3b31b961.js"><link rel="prefetch" href="/assets/js/168.fd5596bd.js"><link rel="prefetch" href="/assets/js/169.a9cde502.js"><link rel="prefetch" href="/assets/js/17.8cc762de.js"><link rel="prefetch" href="/assets/js/170.161fae48.js"><link rel="prefetch" href="/assets/js/171.2c89e0fd.js"><link rel="prefetch" href="/assets/js/172.d65587f3.js"><link rel="prefetch" href="/assets/js/18.db842125.js"><link rel="prefetch" href="/assets/js/20.e26506a4.js"><link rel="prefetch" href="/assets/js/21.8d68d911.js"><link rel="prefetch" href="/assets/js/22.e05a1394.js"><link rel="prefetch" href="/assets/js/23.68e82a67.js"><link rel="prefetch" href="/assets/js/24.41d656e2.js"><link rel="prefetch" href="/assets/js/25.315f9fc2.js"><link rel="prefetch" href="/assets/js/26.4da73a77.js"><link rel="prefetch" href="/assets/js/27.1ad7543a.js"><link rel="prefetch" href="/assets/js/28.28dc36e8.js"><link rel="prefetch" href="/assets/js/29.d542a18d.js"><link rel="prefetch" href="/assets/js/30.5913ee80.js"><link rel="prefetch" href="/assets/js/31.96c515bc.js"><link rel="prefetch" href="/assets/js/32.832d2769.js"><link rel="prefetch" href="/assets/js/33.0b5f2b6c.js"><link rel="prefetch" href="/assets/js/34.f0a43b54.js"><link rel="prefetch" href="/assets/js/35.393f5115.js"><link rel="prefetch" href="/assets/js/36.6931f3d3.js"><link rel="prefetch" href="/assets/js/37.3af59799.js"><link rel="prefetch" href="/assets/js/38.5a1cf05f.js"><link rel="prefetch" href="/assets/js/39.8c552f46.js"><link rel="prefetch" href="/assets/js/4.2c2796bf.js"><link rel="prefetch" href="/assets/js/40.cb569c3b.js"><link rel="prefetch" href="/assets/js/41.6a2b99f8.js"><link rel="prefetch" href="/assets/js/42.687b56eb.js"><link rel="prefetch" href="/assets/js/43.05284af3.js"><link rel="prefetch" href="/assets/js/44.0b67307e.js"><link rel="prefetch" href="/assets/js/45.7f6ef1f3.js"><link rel="prefetch" href="/assets/js/46.8249bf7e.js"><link rel="prefetch" href="/assets/js/47.ec5f420e.js"><link rel="prefetch" href="/assets/js/48.d11a6c13.js"><link rel="prefetch" href="/assets/js/49.e6449fe8.js"><link rel="prefetch" href="/assets/js/50.915ae3af.js"><link rel="prefetch" href="/assets/js/51.f88017be.js"><link rel="prefetch" href="/assets/js/52.19883d30.js"><link rel="prefetch" href="/assets/js/53.fae82d2a.js"><link rel="prefetch" href="/assets/js/54.45609db2.js"><link rel="prefetch" href="/assets/js/55.3ccab79d.js"><link rel="prefetch" href="/assets/js/56.8768fe9f.js"><link rel="prefetch" href="/assets/js/57.6395cc92.js"><link rel="prefetch" href="/assets/js/58.c787abec.js"><link rel="prefetch" href="/assets/js/59.ee218327.js"><link rel="prefetch" href="/assets/js/6.c085291d.js"><link rel="prefetch" href="/assets/js/60.420a1524.js"><link rel="prefetch" href="/assets/js/61.cb40927a.js"><link rel="prefetch" href="/assets/js/62.6f5dbe75.js"><link rel="prefetch" href="/assets/js/63.c719af9c.js"><link rel="prefetch" href="/assets/js/64.0c192abf.js"><link rel="prefetch" href="/assets/js/65.2d535d20.js"><link rel="prefetch" href="/assets/js/66.447f547c.js"><link rel="prefetch" href="/assets/js/67.2f017eb6.js"><link rel="prefetch" href="/assets/js/68.45248a24.js"><link rel="prefetch" href="/assets/js/69.79eef53f.js"><link rel="prefetch" href="/assets/js/7.33994ffb.js"><link rel="prefetch" href="/assets/js/70.45af4bf9.js"><link rel="prefetch" href="/assets/js/71.ecb70702.js"><link rel="prefetch" href="/assets/js/72.77334722.js"><link rel="prefetch" href="/assets/js/73.cf049b79.js"><link rel="prefetch" href="/assets/js/74.c7ae9ca7.js"><link rel="prefetch" href="/assets/js/75.e75e90c2.js"><link rel="prefetch" href="/assets/js/76.8c15077e.js"><link rel="prefetch" href="/assets/js/77.b74dfd89.js"><link rel="prefetch" href="/assets/js/78.9c53503e.js"><link rel="prefetch" href="/assets/js/79.247800a6.js"><link rel="prefetch" href="/assets/js/8.8e0ec08a.js"><link rel="prefetch" href="/assets/js/80.8eba10cc.js"><link rel="prefetch" href="/assets/js/81.1ef35b21.js"><link rel="prefetch" href="/assets/js/82.75aab693.js"><link rel="prefetch" href="/assets/js/83.d7ab8425.js"><link rel="prefetch" href="/assets/js/84.409b433f.js"><link rel="prefetch" href="/assets/js/85.2ca18b23.js"><link rel="prefetch" href="/assets/js/86.f83bd3a3.js"><link rel="prefetch" href="/assets/js/87.65ede75d.js"><link rel="prefetch" href="/assets/js/88.60a2797b.js"><link rel="prefetch" href="/assets/js/89.e1774334.js"><link rel="prefetch" href="/assets/js/9.34339a8e.js"><link rel="prefetch" href="/assets/js/90.920331ed.js"><link rel="prefetch" href="/assets/js/91.17d76450.js"><link rel="prefetch" href="/assets/js/92.e013223a.js"><link rel="prefetch" href="/assets/js/93.03d110a3.js"><link rel="prefetch" href="/assets/js/94.5fe424b6.js"><link rel="prefetch" href="/assets/js/95.5befa7a0.js"><link rel="prefetch" href="/assets/js/96.08a41e97.js"><link rel="prefetch" href="/assets/js/97.bc70a6ba.js"><link rel="prefetch" href="/assets/js/98.3e0af8b3.js"><link rel="prefetch" href="/assets/js/99.264cf17e.js">
    <link rel="stylesheet" href="/assets/css/0.styles.8c46daec.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container no-sidebar"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">心谭博客</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="https://xxoo521.com/frontend/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  前端图谱
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="nav-item"><a href="https://xxoo521.com/algorithm/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  算法题解
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="nav-item"><a href="https://xxoo521.com/archives/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  文章归档
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <a href="https://github.com/dongyuanxin/blog" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="https://xxoo521.com/frontend/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  前端图谱
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="nav-item"><a href="https://xxoo521.com/algorithm/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  算法题解
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="nav-item"><a href="https://xxoo521.com/archives/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  文章归档
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <a href="https://github.com/dongyuanxin/blog" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav>  <!----> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="基于-serverless-的极简网页计数器：源码分析与最佳实践"><a href="#基于-serverless-的极简网页计数器：源码分析与最佳实践" class="header-anchor">#</a> 基于 ServerLess 的极简网页计数器：源码分析与最佳实践</h1> <p><img src="https://cdn.nlark.com/yuque/0/2019/png/233327/1558170012750-30c5b80b-d61b-4c71-9a20-6f98dbc2d81d.png#align=left&amp;display=inline&amp;height=898&amp;name=image.png&amp;originHeight=898&amp;originWidth=1311&amp;size=43753&amp;status=done&amp;width=1311" alt="image.png"></p> <p>这几天基于支持 HTML5 无感认证的 ServerLess 平台开发了一款博客、门户网站等 web 平台常用的 PV 统计工具：<a href="https://github.com/dongyuanxin/page-counter" target="_blank" rel="noopener noreferrer">page-counter<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 。主要用到的技术是 js+webpack。</p> <p>回首看来，解决了以下几个比较有意思的问题：</p> <ul><li>如何设计代码，用统一的方式支持多个 ServerLess 平台？</li> <li>如何架构项目，使得其支持 CDN 和 npm 两种方式引入？</li> <li>如何精简源码，源码大小控制在 4kb？</li> <li>如何借助 webpack 分离生产和测试环境？</li></ul> <p>源码地址：<a href="https://github.com/dongyuanxin/page-counter" target="_blank" rel="noopener noreferrer">https://github.com/dongyuanxin/page-counter<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a><br>npm 地址：<a href="https://www.npmjs.com/package/page-counter" target="_blank" rel="noopener noreferrer">https://www.npmjs.com/package/page-counter<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <p>如果有兴趣的同学，欢迎在阅读完本文后一起接入其他平台的开发； <strong>觉得不错的同学，欢迎给个 Star 哦</strong> 。</p> <h2 id="项目目录"><a href="#项目目录" class="header-anchor">#</a> 项目目录</h2> <p><img src="https://cdn.nlark.com/yuque/0/2019/png/233327/1558166588782-dbc988e3-916e-46ad-895e-1972db727e1c.png" alt="image.png"></p> <p>如上图所示，bin/backend 目录是暂时没用的。几个比较重要的目录功能说明：</p> <ul><li><code>build/</code> : webpack 的配置文件，分别是公共配置、开发模式配置、生产模式配置</li> <li><code>dist/</code> <ul><li>index.template.html: 开发模式下配合 webpack 的 html 模板文件</li> <li>page-counter.min.js: 打包后的 page-counter 内容，供 CDN 引入</li> <li>page-counter.bomb-1.6.7.min.js：我手动修改并且打包的 Bomb 平台源码</li></ul></li> <li><code>examples/</code> : gh-pages 页面，请看<a href="https://godbmw.com/page-counter/" target="_blank" rel="noopener noreferrer">此页面<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><code>deploy.sh</code> : gh-pages 部署脚本，支持 ssh 和 https 协议</li> <li><code>index.js</code> : npm 的入口文件</li> <li><code>index.build.js</code> : CDN 打包入口文件</li> <li><code>src/</code> :
<ul><li><code>serverless/</code> : 暴露不同平台的统一接口</li> <li><code>config.js</code> : 自动读取全局配置</li> <li><code>utils.js</code> : 常用函数方法</li></ul></li></ul> <h2 id="抽象接口：支持多-serverless-平台"><a href="#抽象接口：支持多-serverless-平台" class="header-anchor">#</a> 抽象接口：支持多 Serverless 平台</h2> <p><code>src/serverless/interface.js</code>  中定义了不同平台的类的公共父类。虽然 js 不支持抽象接口，但是也可以通过抛出错误来实现：</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">class</span> <span class="token class-name">ServerLessInterface</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

  <span class="token constant">ACL</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">'Interface method &quot;ACL&quot; must be rewritten'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token function">setData</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">'Interface method &quot;setData&quot; must be rewritten'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token function">count</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">'Interface method &quot;count&quot; must be rewritten'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><p>而 leancloud.js 、bomb.js 等不同平台的类都要实现这个接口中的这 3 个方法。然后通过 <code>src/serverless/index.js</code>  统一暴露出去：</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">import</span> LeanCloud <span class="token keyword">from</span> <span class="token string">&quot;./leancloud&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> Bomb <span class="token keyword">from</span> <span class="token string">&quot;./bomb&quot;</span><span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name">ServerLessFactory</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">name</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    name <span class="token operator">=</span> name<span class="token punctuation">.</span><span class="token function">toLocaleLowerCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">switch</span> <span class="token punctuation">(</span>name<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">case</span> <span class="token string">&quot;leancloud&quot;</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">LeanCloud</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">case</span> <span class="token string">&quot;bomb&quot;</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Bomb</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">default</span><span class="token punctuation">:</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">&quot;Serverless must be one of [ leancloud, bomb ]&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> ServerLessFactory<span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><p>这两种设计，既解耦了不同平台的代码，而且还约束了实现规则。如果想接入更多平台，只需要创建新文件，并且暴露一个继承 <code>ServerLessInterface</code>  接口的指定方法的子类即可。</p> <h2 id="快速方便：支持-cdn-和-npm-的使用"><a href="#快速方便：支持-cdn-和-npm-的使用" class="header-anchor">#</a> 快速方便：支持 CDN 和 npm 的使用</h2> <p>一个成熟的前端小工具需要考虑到多种引入方式，目前主流的就是 cdn 和 npm。例如 jquery，cdn 引入，jq 会被自动挂载在 window 对象上；npm 引入，则作用域只在当前文件模块有用。</p> <p>在考察了多种同类工具后，针对 cdn 和 npm 做了不同的处理。</p> <p><strong>npm</strong> <br>对外暴露 <code>PageCounter</code>  对象，其上有 3 个方法：</p> <ul><li><code>setData()</code> ：将当前页面信息发送到云数据库</li> <li><code>countTotal()</code> : 统计数据库总记录数（网站总 PV），并且将返回结果<strong>自动放入</strong>id 为 page-counter-total-times 的标签里</li> <li><code>countSingle()</code> :  统计数据库符合要求的记录数（当前页面 PV），并且将返回结果<strong>自动放入</strong>id 为 page-counter-single-times 的标签里</li></ul> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">import</span> PageCounter <span class="token keyword">from</span> <span class="token string">&quot;./src&quot;</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> PageCounter<span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p><strong>CDN</strong><br>不会在全局挂载上述对象方法，会自动执行上面的 3 种方法。考虑到并发以及 pv 数允许 1 以内的误差，没有保证串行。</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">import</span> PageCounter <span class="token keyword">from</span> <span class="token string">&quot;./src&quot;</span><span class="token punctuation">;</span>

PageCounter<span class="token punctuation">.</span><span class="token function">setData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
PageCounter<span class="token punctuation">.</span><span class="token function">countTotal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
PageCounter<span class="token punctuation">.</span><span class="token function">countSingle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><h2 id="精简源码：巧用-package-json-和第三方-sdk"><a href="#精简源码：巧用-package-json-和第三方-sdk" class="header-anchor">#</a> 精简源码：巧用 package.json 和第三方 SDK</h2> <p>经过精简，打包后 cdn 引入的源码只有 4kb。npm 引入的话，webpack 会自动进行 tree shaking。因为要对接不同的 serverless 平台，因此需要使用他们的 sdk。</p> <p>而这些 sdk 分成 2 种：</p> <ul><li>类似 leancloud：既可以 npm 引入，也可以 cdn 引入后自动挂载到 window 对象</li> <li>类似 bomb：无 cdn 引入，只要 npm 引入</li></ul> <p>针对第二种情况，我采取的方案是手动打包编译。比如对于 bomb 的 sdk，专门创建新的工程，然后配合 webpack 和以下代码，进行打包。</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">import</span> Bomb <span class="token keyword">from</span> <span class="token string">&quot;hydrogen-js-sdk&quot;</span><span class="token punctuation">;</span>
window<span class="token punctuation">.</span>Bomb <span class="token operator">=</span> Bomb<span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>打包后的源码放入版本库，这样借助  <a href="https://unpkg.com/" target="_blank" rel="noopener noreferrer">https://unpkg.com<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>  等常见的 CDN 平台就可以引入了。这么做的很重要的一点是： <strong>代码中都是通过 window 上的对象读取对应 serverless 平台的 api，这样就不会被 webpack 识别，进而发生重复无用打包</strong> 。</p> <p>关于读取配置的文件，都放在了 <code>src/config.js</code>  下。考虑到 script 标签引入造成的变量挂载时间点不确定，读取采用了动态读取。<strong>为了操作起来更方便，而不是像调用函数那样，借助了 es6 类语法中的 setter 和 getter。</strong></p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">// 举个例子：</span>
<span class="token keyword">class</span> <span class="token class-name">Config</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

  <span class="token keyword">get</span> <span class="token function">serverless</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>window<span class="token punctuation">.</span><span class="token constant">PAGE_COUNTER_CONFIG</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">&quot;Please init variable window.PAGE_COUNTER_CONFIG&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> window<span class="token punctuation">.</span><span class="token constant">PAGE_COUNTER_CONFIG</span><span class="token punctuation">.</span>serverless <span class="token operator">||</span> <span class="token string">&quot;leancloud&quot;</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> config <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Config</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span>serverless<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 返回当前最新的window.PAGE_COUNTER_CONFIG.serverless</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><p>最后讲讲 package.json 的小技巧。虽然代码中没有使用 import 语法读取 sdk 的对象，但是我还是把 leancloud、bomb 平台的 sdk 放入了 <code>dependencies</code> 。这样做有什么好处呢？</p> <p>用户只需要安装 page-counter 即可，其他 sdk 自动安装（不需要手动再敲命令）。然后用户就可以使用下面语法美滋滋引入：</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">import</span><span class="token punctuation">(</span><span class="token string">&quot;hydrogen-js-sdk&quot;</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">res</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// 将 Bomb 对象挂载在 window 上</span>
    window<span class="token punctuation">.</span>Bomb <span class="token operator">=</span> res<span class="token punctuation">.</span>default<span class="token punctuation">;</span>
    <span class="token comment">// 设置应用信息</span>
    window<span class="token punctuation">.</span><span class="token constant">PAGE_COUNTER_CONFIG</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
      <span class="token comment">// ...</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token keyword">import</span><span class="token punctuation">(</span><span class="token string">&quot;page-counter&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">res</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> PageCounter <span class="token operator">=</span> res<span class="token punctuation">.</span>default<span class="token punctuation">;</span>
    PageCounter<span class="token punctuation">.</span><span class="token function">setData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 发送当前页面数据</span>
    PageCounter<span class="token punctuation">.</span><span class="token function">countTotal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 将总浏览量放入 ID 为 page-counter-total-times 的DOM元素中</span>
    PageCounter<span class="token punctuation">.</span><span class="token function">countSingle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 将当前页面浏览量放入 ID 为 page-counter-single-times 的DOM元素中</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><h2 id="webpack：分离生产和开发环境"><a href="#webpack：分离生产和开发环境" class="header-anchor">#</a> Webpack：分离生产和开发环境</h2> <p>不得不说，webpack 真的好用呀。脏活累活以及常见工具，它都给你承包了。</p> <p><code>webpack.base.conf.js</code>  是两种模式的公共配置，指明入口文件以及代码环境（web）。并且能够识别模式，然后自行拼接配置。</p> <p><code>webpack.prod.conf.js</code> ：生产模式，主要为了打包源码，方便 CDN 引入。</p> <p><code>webpack.dev.conf.js</code> : 开启热更新以及本地服务器方便调试，渲染的前端调试页面的模板文件就是 <code>dist/index.template.html</code> 。</p></div> <footer class="page-edit"><div class="edit-link"><a href="https://github.com/dongyuanxin/blog/edit/master/docs/NodeJS/04.Serverless/02.基于ServerLess的极简网页计数器：源码分析与最佳实践.md" target="_blank" rel="noopener noreferrer">在 GitHub 上编辑此页</a> <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></div> <div class="last-updated"><span class="prefix">更新于:</span> <span class="time">10/20/2019, 12:45:13 PM</span></div></footer> <!----> <aside class="right-sidebar"><div class="right-sidebar-links"><div class="right-sidebar-header">关注公众号</div> <img src="https://static.godbmw.com/img/public/wechat-8cm.jpg" alt="公众号搜索：心谭博客" srcset></div> <div class="right-sidebar-links"><div class="right-sidebar-header">
      最近更新
      <a href="/guide/" target="_blank">&gt;&gt;&gt;查看全部</a></div> <div class="right-sidebar-item"><a target="_blank" href="/passages/2019-11-25-promise-a-plus/" title="让我们再聊聊Promise的实现">让我们再聊聊Promise的实现</a></div><div class="right-sidebar-item"><a target="_blank" href="/passages/2019-11-25-how-insist-on-learning/" title="如何保持保持高效学习？">如何保持保持高效学习？</a></div><div class="right-sidebar-item"><a target="_blank" href="/passages/2019-09-04-log-module/" title="日志库的实现机制与优化方法">日志库的实现机制与优化方法</a></div><div class="right-sidebar-item"><a target="_blank" href="/passages/2019-09-03-nodejs-watch-file/" title="NodeJS是如何监听文件的变化？">NodeJS是如何监听文件的变化？</a></div><div class="right-sidebar-item"><a target="_blank" href="/passages/2018-05-23-es-promise/" title="Promise 概述">Promise 概述</a></div><div class="right-sidebar-item"><a target="_blank" href="/passages/2019-11-23-promise-methods/" title="手写Promise的相关方法">手写Promise的相关方法</a></div><div class="right-sidebar-item"><a target="_blank" href="/passages/2019-11-11-wirte-virtual-dom/" title="一文说清「VirtualDOM」的含义与实现">一文说清「VirtualDOM」的含义与实现</a></div><div class="right-sidebar-item"><a target="_blank" href="/passages/2019-03-18-interview-js-code/" title="前端面试中常考的源码实现">前端面试中常考的源码实现</a></div></div> <div class="right-sidebar-links"><div class="right-sidebar-header">
      想法
      <a href="/passages/2019-11-25-how-insist-on-learning/" target="_blank">&gt;&gt;&gt;查看全部</a></div> <div title="如何保持保持高效学习？" class="right-sidebar-item"><a target="_blank" href="/passages/2019-11-25-how-insist-on-learning/" title="如何保持保持高效学习？">如何保持保持高效学习？</a></div></div></aside> </main></div><div class="global-ui"><div class="my-loader center" style="display:none;" data-v-354e1a9e><div class="my-loader-circle" data-v-354e1a9e></div></div><div class="my-popup" style="display:none;" data-v-3414bdeb><div class="my-popup-container" data-v-3414bdeb><div class="my-popup-exit" data-v-3414bdeb></div> <img src="" alt data-v-3414bdeb></div></div><!----><!----><div></div></div></div>
    <script src="/assets/js/app.8d89d060.js" defer></script><script src="/assets/js/2.e1e0c7d5.js" defer></script><script src="/assets/js/3.facfa05b.js" defer></script><script src="/assets/js/19.43a703c5.js" defer></script><script src="/assets/js/5.937ae87d.js" defer></script>
  </body>
</html>
